# docker-compose.yml (Versão Final da Stack PLG)
version: '3.8'

services:
  # ---- SERVIÇO 1: O Servidor Web (Nossa "Aplicação") ----
  web:
    image: nginx:1.25-alpine
    container_name: web-server
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - monitor-net
    restart: always
    deploy:
      resources:
        limits:
          memory: "128M"
    labels:
      - "logging=true"

  # ---- "Tradutor" do Nginx ----
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:1.1.0
    container_name: nginx-exporter
    networks:
      - monitor-net
    restart: always
    command: ["-nginx.scrape-uri", "http://web/stub_status"]
    deploy:
      resources:
        limits:
          memory: "128M"
    labels:
      - "logging=true"

  # ---- SERVIÇO 2: O Banco de Dados (Nosso "Backend") ----
  db:
    image: mariadb:10.11
    container_name: db-server
    networks:
      - monitor-net
    restart: always
    volumes:
      - db-data:/var/lib/mysql
    environment:
      - MARIADB_ROOT_PASSWORD=noc_secret_password
      - MARIADB_DATABASE=app_db
    deploy:
      resources:
        limits:
          memory: "512M"
    labels:
      - "logging=true"

  # ---- SERVIÇO 3: Cérebro de Métricas (Prometheus) ----
  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: prometheus-server
    ports:
      - "9090:9090"
    networks:
      - monitor-net
    restart: always
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    deploy:
      resources:
        limits:
          memory: "512M"
    labels:
      - "logging=true"

  # ---- SERVIÇO 4: Cérebro de Logs (Loki) ----
  loki:
    image: grafana/loki:2.9.0
    container_name: loki-server
    ports:
      - "3100:3100"
    networks:
      - monitor-net
    volumes:
      - ./loki/loki-config.yml:/etc/loki/config.yml
      - loki-data:/loki
    restart: always
    deploy:
      resources:
        limits:
          memory: "512M"
    labels:
      - "logging=true"

  # ---- SERVIÇO 5: Coletor de Logs (Promtail) ----
  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail-agent
    networks:
      - monitor-net
    volumes:
      - ./loki/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock
      - promtail-positions:/tmp
    restart: always
    deploy:
      resources:
        limits:
          memory: "128M"
    labels:
      - "logging=true"

  # ---- SERVIÇO 6: O Painel de Vidro (Grafana) ----
  grafana:
    # Usamos a imagem OSS (Open Source Software), que é leve
    image: grafana/grafana-oss:10.2.0
    container_name: grafana-server
    ports:
      # A porta padrão do Grafana é 3000
      - "3000:3000"
    networks:
      - monitor-net
    volumes:
      # Volume para o Grafana guardar dashboards, etc
      - grafana-data:/var/lib/grafana
      # O nosso ficheiro de provisioning!
      - ./grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
    restart: always
    deploy:
      resources:
        limits:
          memory: "512M" # Grafana precisa de um pouco de RAM
    labels:
      - "logging=true"

# 'volumes' no nível superior (top-level) declaram os "HDs externos"
volumes:
  db-data:
    driver: local
  prometheus-data:
    driver: local
  loki-data:
    driver: local
  promtail-positions:
    driver: local
  # Novo volume para o Grafana
  grafana-data:
    driver: local

# 'networks' é onde definimos as redes que nossos serviços usarão
networks:
  monitor-net:
    driver: bridge
    name: monitor-net